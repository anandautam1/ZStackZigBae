###############################################################################
#                                                                             #
# IAR C/C++ Compiler V7.51A/W32 for 8051                08/Jun/2011  10:49:48 #
# Copyright 2004-2009 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\Texas Instruments\ZStack-CC2530-2.3.1\Component #
#                          s\stack\sys\ZGlobals.c                             #
#    Command line       =  -f "C:\Texas Instruments\ZStack-CC2530-2.3.1\Proje #
#                          cts\zstack\Samples\SampleApp\CC2530DB\..\..\..\Too #
#                          ls\CC2530DB\f8wCoord.cfg" (-DCPU32MHZ              #
#                          -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                          E -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8       #
#                          -DMAC_CFG_RX_MAX=5 -DZDO_COORDINATOR -DRTR_NWK)    #
#                          -f "C:\Texas Instruments\ZStack-CC2530-2.3.1\Proje #
#                          cts\zstack\Samples\SampleApp\CC2530DB\..\..\..\Too #
#                          ls\CC2530DB\f8wConfig.cfg" (-DSECURE=0             #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.3.1\Components\stack\s #
#                          ys\ZGlobals.c" -D BUILD_ALL_DEVICES -D             #
#                          HOLD_AUTO_START -D LCD_SUPPORTED -D                #
#                          HAL_UART=FALSE -lC "C:\Texas                       #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\DemoEB\List\" -lA         #
#                          "C:\Texas Instruments\ZStack-CC2530-2.3.1\Projects #
#                          \zstack\Samples\SampleApp\CC2530DB\DemoEB\List\"   #
#                          --diag_suppress Pe001,Pa010 -o "C:\Texas           #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\DemoEB\Obj\" -e           #
#                          --require_prototypes --debug --core=plain          #
#                          --dptr=16,1 --data_model=large                     #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 16 -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\" -I "C:\Texas            #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\SOURCE\" -I "C:\Texas  #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\ZMAIN\TI2530DB\" #
#                           -I "C:\Texas Instruments\ZStack-CC2530-2.3.1\Proj #
#                          ects\zstack\Samples\SampleApp\CC2530DB\..\..\..\.. #
#                          \..\COMPONENTS\MT\" -I "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \HAL\INCLUDE\" -I "C:\Texas                        #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \HAL\TARGET\CC2530EB\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \OSAL\MCU\CCSOC\" -I "C:\Texas                     #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \OSAL\INCLUDE\" -I "C:\Texas                       #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\AF\" -I "C:\Texas                           #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\NWK\" -I "C:\Texas                          #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\SEC\" -I "C:\Texas                          #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\SAPI\" -I "C:\Texas                         #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\SYS\" -I "C:\Texas                          #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\ZDO\" -I "C:\Texas                          #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \ZMAC\F8W\" -I "C:\Texas                           #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \ZMAC\" -I "C:\Texas Instruments\ZStack-CC2530-2.3 #
#                          .1\Projects\zstack\Samples\SampleApp\CC2530DB\..\. #
#                          .\..\..\..\COMPONENTS\SERVICES\SADDR\" -I          #
#                          "C:\Texas Instruments\ZStack-CC2530-2.3.1\Projects #
#                          \zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\SERVICES\SDATA\" -I "C:\Texas           #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \MAC\INCLUDE\" -I "C:\Texas                        #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \MAC\HIGH_LEVEL\" -I "C:\Texas                     #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \MAC\LOW_LEVEL\srf04\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \MAC\LOW_LEVEL\srf04\SINGLE_CHIP\" -I "C:\Program  #
#                          Files\IAR Systems\Embedded Workbench               #
#                          5.3\8051\INC\" -I "C:\Program Files\IAR            #
#                          Systems\Embedded Workbench 5.3\8051\INC\CLIB\"     #
#                          -Ohz                                               #
#    List file          =  C:\Texas Instruments\ZStack-CC2530-2.3.1\Projects\ #
#                          zstack\Samples\SampleApp\CC2530DB\DemoEB\List\ZGlo #
#                          bals.lst                                           #
#    Object file        =  C:\Texas Instruments\ZStack-CC2530-2.3.1\Projects\ #
#                          zstack\Samples\SampleApp\CC2530DB\DemoEB\Obj\ZGlob #
#                          als.r51                                            #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-CC2530-2.3.1\Components\stack\sys\ZGlobals.c
      1          /**************************************************************************************************
      2            Filename:       ZGlobals.c
      3            Revised:        $Date: 2010-08-18 18:19:45 -0700 (Wed, 18 Aug 2010) $
      4            Revision:       $Revision: 23451 $
      5          
      6            Description:    User definable Z-Stack parameters.
      7          
      8          
      9            Copyright 2007-2010 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com.
     38          **************************************************************************************************/
     39          
     40          /*********************************************************************
     41           * INCLUDES
     42           */
     43          
     44          #include "ZComDef.h"
     45          #include "OSAL_Nv.h"
     46          #include "ZDObject.h"
     47          #include "ZGlobals.h"
     48          #include "ZDNwkMgr.h"
     49          #include "OnBoard.h"
     50          #include "ZDSecMgr.h"
     51          
     52          /*********************************************************************
     53           * MACROS
     54           */
     55          
     56          /*********************************************************************
     57           * CONSTANTS
     58           */
     59          
     60          /*********************************************************************
     61           * TYPEDEFS
     62           */
     63          
     64          typedef struct zgItem
     65          {
     66            uint16 id;
     67            uint16 len;
     68            void *buf;
     69          } zgItem_t;
     70          
     71          /*********************************************************************
     72           * NWK GLOBAL VARIABLES
     73           */
     74          
     75          // Polling values
     76          uint16 zgPollRate = POLL_RATE;
     77          uint16 zgQueuedPollRate = QUEUED_POLL_RATE;
     78          uint16 zgResponsePollRate = RESPONSE_POLL_RATE;
     79          uint16 zgRejoinPollRate = REJOIN_POLL_RATE;
     80          
     81          // Transmission retries numbers
     82          uint8 zgMaxDataRetries = NWK_MAX_DATA_RETRIES;
     83          uint8 zgMaxPollFailureRetries = MAX_POLL_FAILURE_RETRIES;
     84          
     85          // Default channel list
     86          uint32 zgDefaultChannelList = DEFAULT_CHANLIST;
     87          
     88          // Default starting scan duration
     89          uint8 zgDefaultStartingScanDuration = STARTING_SCAN_DURATION;
     90          
     91          // Stack profile Id
     92          uint8 zgStackProfile = STACK_PROFILE_ID;
     93          
     94          // Default indirect message holding timeout
     95          uint8 zgIndirectMsgTimeout = NWK_INDIRECT_MSG_TIMEOUT;
     96          
     97          // Security mode
     98          uint8 zgSecurityMode = ZG_SECURITY_MODE;
     99          
    100          // Secure permit join
    101          uint8 zgSecurePermitJoin = true;
    102          
    103          // Trust center address
    104          uint16 zgTrustCenterAddr = ZG_TRUSTCENTER_ADDR;
    105          
    106          // Route Discovery Time - amount of time that a route request lasts
    107          uint8 zgRouteDiscoveryTime = ROUTE_DISCOVERY_TIME;
    108          
    109          // Route expiry
    110          uint8 zgRouteExpiryTime = ROUTE_EXPIRY_TIME;
    111          
    112          // Extended PAN Id
    113          uint8 zgExtendedPANID[Z_EXTADDR_LEN];
    114          
    115          // Broadcast parameters
    116          uint8 zgMaxBcastRetires   = MAX_BCAST_RETRIES;
    117          uint8 zgPassiveAckTimeout = PASSIVE_ACK_TIMEOUT;
    118          uint8 zgBcastDeliveryTime = BCAST_DELIVERY_TIME;
    119          
    120          // Network mode
    121          uint8 zgNwkMode = NWK_MODE;
    122          
    123          // Many-to-one values
    124          uint8 zgConcentratorEnable = CONCENTRATOR_ENABLE;
    125          uint8 zgConcentratorDiscoveryTime = CONCENTRATOR_DISCOVERY_TIME;
    126          uint8 zgConcentratorRadius = CONCENTRATOR_RADIUS;
    127          uint8 zgConcentratorRC = CONCENTRATOR_ROUTE_CACHE;   // concentrator with route cache (no memory constraints)
    128          uint8 zgNwkSrcRtgExpiryTime = SRC_RTG_EXPIRY_TIME;
    129          
    130          /*********************************************************************
    131           * APS GLOBAL VARIABLES
    132           */
    133          
    134          // The maximum number of retries allowed after a transmission failure
    135          uint8 zgApscMaxFrameRetries = APSC_MAX_FRAME_RETRIES;
    136          
    137          // The maximum number of seconds (milliseconds) to wait for an
    138          // acknowledgement to a transmitted frame.
    139          
    140          // This number is used by polled devices.
    141          uint16 zgApscAckWaitDurationPolled = APSC_ACK_WAIT_DURATION_POLLED;
    142          
    143          // This number is used by non-polled devices in the following formula:
    144          //   (100 mSec) * (_NIB.MaxDepth * zgApsAckWaitMultiplier)
    145          uint8 zgApsAckWaitMultiplier = 2;
    146          
    147          // The maximum number of milliseconds for the end device binding
    148          uint16 zgApsDefaultMaxBindingTime = APS_DEFAULT_MAXBINDING_TIME;
    149          
    150          // The 64-big identifier of the network to join or form.
    151          // Default set to all zeros
    152          uint8 zgApsUseExtendedPANID[Z_EXTADDR_LEN] = {00,00,00,00,00,00,00,00};
    153          
    154          // A boolean flag that indicates whether it is OK to use insecure join
    155          // on startup. Default set to true
    156          uint8 zgApsUseInsecureJoin = TRUE;
    157          
    158          // The radius of broadcast multicast transmissions
    159          uint8 zgApsNonMemberRadius = APS_DEFAULT_NONMEMBER_RADIUS;
    160          
    161          // The size of a tx window when using fragmentation
    162          uint8 zgApsfMaxWindowSize = APSF_DEFAULT_WINDOW_SIZE;
    163          
    164          // The delay between tx packets when using fragmentaition
    165          uint16 zgApsfInterframeDelay = APSF_DEFAULT_INTERFRAME_DELAY;
    166          
    167          /*********************************************************************
    168           * SECURITY GLOBAL VARIABLES
    169           */
    170          
    171          // If true, preConfigKey should be configured on all devices on the network
    172          // If false, it is configured only on the coordinator and sent to other
    173          // devices upon joining.
    174          uint8 zgPreConfigKeys = FALSE;// TRUE;
    175          
    176          // If true, defaultTCLinkKey should be configured on all devices on the
    177          // network. If false, individual trust center link key between each device and
    178          // the trust center should be manually configured via MT_WRITE_NV
    179          uint8 zgUseDefaultTCLK = TRUE; // FALSE
    180          
    181          /*********************************************************************
    182           * ZDO GLOBAL VARIABLES
    183           */
    184          
    185          // Configured PAN ID
    186          uint16 zgConfigPANID = ZDAPP_CONFIG_PAN_ID;
    187          
    188          // Device Logical Type
    189          uint8 zgDeviceLogicalType = DEVICE_LOGICAL_TYPE;
    190          
    191          // Startup Delay
    192          uint8 zgStartDelay = START_DELAY;
    193          
    194          #if !defined MT_TASK
    195          // Flag to use verbose (i.e. "cc2480-style") direct MT callbacks in ZDProfile.c, ZDP_IncomingData().
    196          uint8 zgZdoDirectCB = FALSE;
    197          #endif
    198          
    199          // Min number of attempted transmissions for Channel Interference detection
    200          uint8 zgNwkMgrMinTransmissions = ZDNWKMGR_MIN_TRANSMISSIONS;
    201          
    202          /*********************************************************************
    203           * APPLICATION GLOBAL VARIABLES
    204           */
    205          
    206          // Network Manager Mode
    207          uint8 zgNwkMgrMode = ZDNWKMGR_ENABLE;
    208          
    209          /*********************************************************************
    210           * NON-STANDARD GLOBAL VARIABLES
    211           */
    212          
    213          // Simple API Endpoint
    214          uint8 zgSapiEndpoint = SAPI_ENDPOINT;
    215          
    216          /*********************************************************************
    217           * LOCAL VARIABLES
    218           */
    219          
    220          /*********************************************************************
    221           * ZGlobal Item Table
    222           */
    223          static CONST zgItem_t zgItemTable[] =
    224          {
    225          #if defined ( NV_INIT )
    226          #if !defined MT_TASK
    227            {
    228              ZCD_NV_ZDO_DIRECT_CB, sizeof(zgZdoDirectCB), &zgZdoDirectCB
    229            },
    230          #endif
    231            {
    232              ZCD_NV_LOGICAL_TYPE, sizeof(zgDeviceLogicalType), &zgDeviceLogicalType
    233            },
    234            {
    235              ZCD_NV_POLL_RATE, sizeof(zgPollRate), &zgPollRate
    236            },
    237            {
    238              ZCD_NV_QUEUED_POLL_RATE, sizeof(zgQueuedPollRate), &zgQueuedPollRate
    239            },
    240            {
    241              ZCD_NV_RESPONSE_POLL_RATE, sizeof(zgResponsePollRate), &zgResponsePollRate
    242            },
    243            {
    244              ZCD_NV_REJOIN_POLL_RATE, sizeof(zgRejoinPollRate), &zgRejoinPollRate
    245            },
    246            {
    247              ZCD_NV_DATA_RETRIES, sizeof(zgMaxDataRetries), &zgMaxDataRetries
    248            },
    249            {
    250              ZCD_NV_POLL_FAILURE_RETRIES, sizeof(zgMaxPollFailureRetries), &zgMaxPollFailureRetries
    251            },
    252            {
    253              ZCD_NV_CHANLIST, sizeof(zgDefaultChannelList), &zgDefaultChannelList
    254            },
    255            {
    256              ZCD_NV_SCAN_DURATION, sizeof(zgDefaultStartingScanDuration), &zgDefaultStartingScanDuration
    257            },
    258            {
    259              ZCD_NV_STACK_PROFILE, sizeof(zgStackProfile), &zgStackProfile
    260            },
    261            {
    262              ZCD_NV_INDIRECT_MSG_TIMEOUT, sizeof(zgIndirectMsgTimeout), &zgIndirectMsgTimeout
    263            },
    264            {
    265              ZCD_NV_ROUTE_EXPIRY_TIME, sizeof(zgRouteExpiryTime), &zgRouteExpiryTime
    266            },
    267            {
    268              ZCD_NV_EXTENDED_PAN_ID, Z_EXTADDR_LEN, zgExtendedPANID
    269            },
    270            {
    271              ZCD_NV_BCAST_RETRIES, sizeof(zgMaxBcastRetires), &zgMaxBcastRetires
    272            },
    273            {
    274              ZCD_NV_PASSIVE_ACK_TIMEOUT, sizeof(zgPassiveAckTimeout), &zgPassiveAckTimeout
    275            },
    276            {
    277              ZCD_NV_BCAST_DELIVERY_TIME, sizeof(zgBcastDeliveryTime), &zgBcastDeliveryTime
    278            },
    279            {
    280              ZCD_NV_NWK_MODE, sizeof(zgNwkMode), &zgNwkMode
    281            },
    282            {
    283              ZCD_NV_CONCENTRATOR_ENABLE, sizeof(zgConcentratorEnable), &zgConcentratorEnable
    284            },
    285            {
    286              ZCD_NV_CONCENTRATOR_DISCOVERY, sizeof(zgConcentratorDiscoveryTime), &zgConcentratorDiscoveryTime
    287            },
    288            {
    289              ZCD_NV_CONCENTRATOR_RADIUS, sizeof(zgConcentratorRadius), &zgConcentratorRadius
    290            },
    291            {
    292              ZCD_NV_CONCENTRATOR_RC, sizeof(zgConcentratorRC), &zgConcentratorRC
    293            },
    294            {
    295              ZCD_NV_SRC_RTG_EXPIRY_TIME, sizeof(zgNwkSrcRtgExpiryTime), &zgNwkSrcRtgExpiryTime
    296            },
    297            {
    298              ZCD_NV_ROUTE_DISCOVERY_TIME, sizeof(zgRouteDiscoveryTime), &zgRouteDiscoveryTime
    299            },
    300          #ifndef NONWK
    301            {
    302              ZCD_NV_PANID, sizeof(zgConfigPANID), &zgConfigPANID
    303            },
    304            {
    305              ZCD_NV_PRECFGKEYS_ENABLE, sizeof(zgPreConfigKeys), &zgPreConfigKeys
    306            },
    307            {
    308              ZCD_NV_SECURITY_MODE, sizeof(zgSecurityMode), &zgSecurityMode
    309            },
    310            {
    311              ZCD_NV_SECURE_PERMIT_JOIN, sizeof(zgSecurePermitJoin), &zgSecurePermitJoin
    312            },
    313            {
    314              ZCD_NV_USE_DEFAULT_TCLK, sizeof(zgUseDefaultTCLK), &zgUseDefaultTCLK
    315            },
    316            {
    317              ZCD_NV_TRUSTCENTER_ADDR, sizeof(zgTrustCenterAddr), &zgTrustCenterAddr
    318            },
    319          #endif // NONWK
    320            {
    321              ZCD_NV_APS_FRAME_RETRIES, sizeof(zgApscMaxFrameRetries), &zgApscMaxFrameRetries
    322            },
    323            {
    324              ZCD_NV_APS_ACK_WAIT_DURATION, sizeof(zgApscAckWaitDurationPolled), &zgApscAckWaitDurationPolled
    325            },
    326            {
    327              ZCD_NV_APS_ACK_WAIT_MULTIPLIER, sizeof(zgApsAckWaitMultiplier), &zgApsAckWaitMultiplier
    328            },
    329            {
    330              ZCD_NV_BINDING_TIME, sizeof(zgApsDefaultMaxBindingTime), &zgApsDefaultMaxBindingTime
    331            },
    332            {
    333              ZCD_NV_APS_USE_EXT_PANID, Z_EXTADDR_LEN, zgApsUseExtendedPANID
    334            },
    335            {
    336              ZCD_NV_APS_USE_INSECURE_JOIN, sizeof(zgApsUseInsecureJoin), &zgApsUseInsecureJoin
    337            },
    338            {
    339              ZCD_NV_APSF_WINDOW_SIZE, sizeof(zgApsfMaxWindowSize), &zgApsfMaxWindowSize
    340            },
    341            {
    342              ZCD_NV_APSF_INTERFRAME_DELAY, sizeof(zgApsfInterframeDelay), &zgApsfInterframeDelay
    343            },
    344            {
    345              ZCD_NV_APS_NONMEMBER_RADIUS, sizeof(zgApsNonMemberRadius), &zgApsNonMemberRadius
    346            },
    347            {
    348              ZCD_NV_START_DELAY, sizeof(zgStartDelay), &zgStartDelay
    349            },
    350            {
    351              ZCD_NV_SAPI_ENDPOINT, sizeof(zgSapiEndpoint), &zgSapiEndpoint
    352            },
    353            {
    354              ZCD_NV_NWK_MGR_MODE, sizeof(zgNwkMgrMode), &zgNwkMgrMode
    355            },
    356            {
    357              ZCD_NV_NWKMGR_MIN_TX, sizeof(zgNwkMgrMinTransmissions), &zgNwkMgrMinTransmissions
    358            },
    359          #endif // NV_INIT
    360            // Last item -- DO NOT MOVE IT!
    361            {
    362              0x00, 0, NULL
    363            }
    364          };
    365          
    366          /*********************************************************************
    367           * LOCAL FUNCTIONS
    368           */
    369          
    370          static uint8 zgItemInit( uint16 id, uint16 len, void *buf, uint8 setDefault );
    371          static uint8 zgPreconfigKeyInit( uint8 setDefault );
    372          
    373          /*********************************************************************
    374           * @fn       zgItemInit()
    375           *
    376           * @brief
    377           *
    378           *   Initialize a global item. If the item doesn't exist in NV memory,
    379           *   write the system default (value passed in) into NV memory. But if
    380           *   it exists, set the item to the value stored in NV memory.
    381           *
    382           *   Also, if setDefault is TRUE and the item exists, we will write
    383           *   the default value to NV space.
    384           *
    385           * @param   id - item id
    386           * @param   len - item len
    387           * @param   buf - pointer to the item
    388           * @param   setDefault - TRUE to set default, not read
    389           *
    390           * @return  ZSUCCESS if successful, NV_ITEM_UNINIT if item did not
    391           *          exist in NV, NV_OPER_FAILED if failure.
    392           */
    393          static uint8 zgItemInit( uint16 id, uint16 len, void *buf, uint8 setDefault )
    394          {
    395            uint8 status;
    396          
    397            // If the item doesn't exist in NV memory, create and initialize
    398            // it with the value passed in.
    399            status = osal_nv_item_init( id, len, buf );
    400            if ( status == ZSUCCESS )
    401            {
    402              if ( setDefault )
    403              {
    404                // Write the default value back to NV
    405                status = osal_nv_write( id, 0, len, buf );
    406              }
    407              else
    408              {
    409                // The item exists in NV memory, read it from NV memory
    410                status = osal_nv_read( id, 0, len, buf );
    411              }
    412            }
    413          
    414            return (status);
    415          }
    416          
    417          /*********************************************************************
    418           * API FUNCTIONS
    419           */
    420          
    421          /*********************************************************************
    422           * @fn          zgInit
    423           *
    424           * @brief
    425           *
    426           *   Initialize the Z-Stack Globals. If an item doesn't exist in
    427           *   NV memory, write the system default into NV memory. But if
    428           *   it exists, set the item to the value stored in NV memory.
    429           *
    430           * NOTE: The Startup Options (ZCD_NV_STARTUP_OPTION) indicate
    431           *       that the Config state items (zgItemTable) need to be
    432           *       set to defaults (ZCD_STARTOPT_DEFAULT_CONFIG_STATE). The
    433           *
    434           * @param       none
    435           *
    436           * @return      ZSUCCESS if successful, NV_ITEM_UNINIT if item did not
    437           *              exist in NV, NV_OPER_FAILED if failure.
    438           */
    439          uint8 zgInit( void )
    440          {
    441            uint8  setDefault = FALSE;
    442          
    443            // Do we want to default the Config state values
    444            if ( zgReadStartupOptions() & ZCD_STARTOPT_DEFAULT_CONFIG_STATE )
    445            {
    446              setDefault = TRUE;
    447            }
    448          
    449          #if 0
    450            // Enable this section if you need to track the number of resets
    451            // This section is normally disabled to minimize "wear" on NV memory
    452            uint16 bootCnt = 0;
    453          
    454            // Update the Boot Counter
    455            if ( osal_nv_item_init( ZCD_NV_BOOTCOUNTER, sizeof(bootCnt), &bootCnt ) == ZSUCCESS )
    456            {
    457              // Get the old value from NV memory
    458              osal_nv_read( ZCD_NV_BOOTCOUNTER, 0, sizeof(bootCnt), &bootCnt );
    459            }
    460          
    461            // Increment the Boot Counter and store it into NV memory
    462            if ( setDefault )
    463              bootCnt = 0;
    464            else
    465              bootCnt++;
    466            osal_nv_write( ZCD_NV_BOOTCOUNTER, 0, sizeof(bootCnt), &bootCnt );
    467          #endif
    468          
    469            // Initialize the Extended PAN ID as my own extended address
    470            ZMacGetReq( ZMacExtAddr, zgExtendedPANID );
    471          
    472            // Initialize the items table
    473            zgInitItems( setDefault );
    474          
    475          #ifndef NONWK
    476            if ( ZG_SECURE_ENABLED )
    477            {
    478              // Initialize the Pre-Configured Key to the default key
    479              zgPreconfigKeyInit( setDefault );
    480          
    481              // Initialize NV items for all Keys: NWK, APS, TCLK and Master
    482              ZDSecMgrInitNVKeyTables( setDefault );
    483            }
    484          #endif // NONWK
    485          
    486            // Clear the Config State default
    487            if ( setDefault )
    488            {
    489              zgWriteStartupOptions( ZG_STARTUP_CLEAR, ZCD_STARTOPT_DEFAULT_CONFIG_STATE );
    490            }
    491          
    492            return ( ZSUCCESS );
    493          }
    494          
    495          /*********************************************************************
    496           * @fn          zgInitItems
    497           *
    498           * @brief       Initializes RAM variables from NV.  If NV items don't
    499           *              exist, then the NV is initialize with what is in RAM
    500           *              variables.
    501           *
    502           * @param       none
    503           *
    504           * @return      none
    505           */
    506          void zgInitItems( uint8 setDefault )
    507          {
    508            uint8  i = 0;
    509          
    510            while ( zgItemTable[i].id != 0x00 )
    511            {
    512              // Initialize the item
    513              zgItemInit( zgItemTable[i].id, zgItemTable[i].len, zgItemTable[i].buf, setDefault  );
    514          
    515              // Move on to the next item
    516              i++;
    517            }
    518          }
    519          
    520          /*********************************************************************
    521           * @fn          zgReadStartupOptions
    522           *
    523           * @brief       Reads the ZCD_NV_STARTUP_OPTION NV Item.
    524           *
    525           * @param       none
    526           *
    527           * @return      the ZCD_NV_STARTUP_OPTION NV item
    528           */
    529          uint8 zgReadStartupOptions( void )
    530          {
    531            // Default to Use Config State and Use Network State
    532            uint8 startupOption = 0;
    533          
    534            // This should have been done in ZMain.c, but just in case.
    535            if ( osal_nv_item_init( ZCD_NV_STARTUP_OPTION,
    536                                        sizeof(startupOption),
    537                                        &startupOption ) == ZSUCCESS )
    538            {
    539              // Read saved startup control
    540              osal_nv_read( ZCD_NV_STARTUP_OPTION,
    541                            0,
    542                            sizeof( startupOption ),
    543                            &startupOption);
    544            }
    545            return ( startupOption );
    546          }
    547          
    548          /*********************************************************************
    549           * @fn          zgWriteStartupOptions
    550           *
    551           * @brief       Writes bits into the ZCD_NV_STARTUP_OPTION NV Item.
    552           *
    553           * @param       action - ZG_STARTUP_SET set bit, ZG_STARTUP_CLEAR to
    554           *               clear bit. The set bit is an OR operation, and the
    555           *               clear bit is an AND ~(bitOptions) operation.
    556           *
    557           * @param       bitOptions - which bits to perform action on:
    558           *                      ZCD_STARTOPT_DEFAULT_CONFIG_STATE
    559           *                      ZCD_STARTOPT_DEFAULT_NETWORK_STATE
    560           *
    561           * @return      ZSUCCESS if successful
    562           */
    563          uint8 zgWriteStartupOptions( uint8 action, uint8 bitOptions )
    564          {
    565            uint8 status;
    566            uint8 startupOptions = 0;
    567          
    568            status = osal_nv_read( ZCD_NV_STARTUP_OPTION,
    569                          0,
    570                          sizeof( startupOptions ),
    571                          &startupOptions );
    572          
    573            if ( status == ZSUCCESS )
    574            {
    575              if ( action == ZG_STARTUP_SET )
    576              {
    577                // Set bits
    578                startupOptions |= bitOptions;
    579              }
    580              else
    581              {
    582                // Clear bits
    583                startupOptions &= (bitOptions ^ 0xFF);
    584              }
    585          
    586              // Changed?
    587              status = osal_nv_write( ZCD_NV_STARTUP_OPTION,
    588                           0,
    589                           sizeof( startupOptions ),
    590                           &startupOptions );
    591            }
    592          
    593            return ( status );
    594          }
    595          
    596          /*********************************************************************
    597           * @fn          zgSetItem
    598           *
    599           * @brief       Set RAM variables from set-NV, if it exist in the zgItemTable
    600           *
    601           * @param       id - NV ID
    602           *              len - NV item length
    603           *              buf - pointer to the input buffer
    604           *
    605           * @return      none
    606           */
    607          void zgSetItem( uint16 id, uint16 len, void *buf )
    608          {
    609          
    610            uint8  i = 0;
    611          
    612            // Look up the NV item table
    613            while ( zgItemTable[i].id != 0x00 )
    614            {
    615              if( zgItemTable[i].id == id )
    616              {
    617                if ( zgItemTable[i].len == len )
    618                {
    619                  osal_memcpy( zgItemTable[i].buf, buf, len );
    620                }
    621                break;
    622              }
    623              // Move on to the next item
    624              i++;
    625            }
    626          }
    627          
    628          /*********************************************************************
    629           * @fn       zgPreconfigKeyInit()
    630           *
    631           * @brief
    632           *
    633           *   Initialize ZCD_NV_PRECFGKEY NV item. If the item doesn't exist in NV memory,
    634           *   write the system default (value passed in) into NV memory. But if
    635           *   it exists do not overwrite it.
    636           *
    637           *   Also, if setDefault is TRUE and the item exists, we will write
    638           *   the default value to NV space.
    639           *
    640           * @param   setDefault - TRUE to set default
    641           *
    642           * @return  ZSUCCESS if successful, NV_ITEM_UNINIT if item did not
    643           *          exist in NV, NV_OPER_FAILED if failure.
    644           */
    645          static uint8 zgPreconfigKeyInit( uint8 setDefault )
    646          {
    647            uint8 zgPreConfigKey[SEC_KEY_LEN];
    648            uint8 status;
    649          
    650            // Initialize the Pre-Configured Key to the default key
    651            osal_memcpy( zgPreConfigKey, defaultKey, SEC_KEY_LEN );
    652          
    653            // If the item doesn't exist in NV memory, create and initialize it
    654            status = osal_nv_item_init( ZCD_NV_PRECFGKEY, SEC_KEY_LEN, zgPreConfigKey );
    655            if ( status == ZSUCCESS )
    656            {
    657              if ( setDefault )
    658              {
    659                // Write the default value back to NV
    660                status =  osal_nv_write( ZCD_NV_PRECFGKEY, 0, SEC_KEY_LEN, zgPreConfigKey );
    661              }
    662            }
    663          
    664            // clear local copy of default key
    665            osal_memset(zgPreConfigKey, 0x00, SEC_KEY_LEN);
    666          
    667            return (status);
    668          }
    669          
    670          /*********************************************************************
    671          *********************************************************************/

Errors: 1
Warnings: none
