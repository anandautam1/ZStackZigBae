###############################################################################
#                                                                             #
# IAR C/C++ Compiler V7.51A/W32 for 8051                08/Jun/2011  10:49:40 #
# Copyright 2004-2009 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\Texas Instruments\ZStack-CC2530-2.3.1\Component #
#                          s\mt\MT_TASK.c                                     #
#    Command line       =  -f "C:\Texas Instruments\ZStack-CC2530-2.3.1\Proje #
#                          cts\zstack\Samples\SampleApp\CC2530DB\..\..\..\Too #
#                          ls\CC2530DB\f8wCoord.cfg" (-DCPU32MHZ              #
#                          -DROOT=__near_func -DMAC_CFG_APP_PENDING_QUEUE=TRU #
#                          E -DMAC_CFG_TX_DATA_MAX=5 -DMAC_CFG_TX_MAX=8       #
#                          -DMAC_CFG_RX_MAX=5 -DZDO_COORDINATOR -DRTR_NWK)    #
#                          -f "C:\Texas Instruments\ZStack-CC2530-2.3.1\Proje #
#                          cts\zstack\Samples\SampleApp\CC2530DB\..\..\..\Too #
#                          ls\CC2530DB\f8wConfig.cfg" (-DSECURE=0             #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.3.1\Components\mt\MT_T #
#                          ASK.c" -D BUILD_ALL_DEVICES -D HOLD_AUTO_START -D  #
#                          LCD_SUPPORTED -D HAL_UART=FALSE -lC "C:\Texas      #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\DemoEB\List\" -lA         #
#                          "C:\Texas Instruments\ZStack-CC2530-2.3.1\Projects #
#                          \zstack\Samples\SampleApp\CC2530DB\DemoEB\List\"   #
#                          --diag_suppress Pe001,Pa010 -o "C:\Texas           #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\DemoEB\Obj\" -e           #
#                          --require_prototypes --debug --core=plain          #
#                          --dptr=16,1 --data_model=large                     #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 16 -I "C:\Texas                  #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\" -I "C:\Texas            #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\SOURCE\" -I "C:\Texas  #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\ZMAIN\TI2530DB\" #
#                           -I "C:\Texas Instruments\ZStack-CC2530-2.3.1\Proj #
#                          ects\zstack\Samples\SampleApp\CC2530DB\..\..\..\.. #
#                          \..\COMPONENTS\MT\" -I "C:\Texas                   #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \HAL\INCLUDE\" -I "C:\Texas                        #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \HAL\TARGET\CC2530EB\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \OSAL\MCU\CCSOC\" -I "C:\Texas                     #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \OSAL\INCLUDE\" -I "C:\Texas                       #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\AF\" -I "C:\Texas                           #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\NWK\" -I "C:\Texas                          #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\SEC\" -I "C:\Texas                          #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\SAPI\" -I "C:\Texas                         #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\SYS\" -I "C:\Texas                          #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \STACK\ZDO\" -I "C:\Texas                          #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \ZMAC\F8W\" -I "C:\Texas                           #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \ZMAC\" -I "C:\Texas Instruments\ZStack-CC2530-2.3 #
#                          .1\Projects\zstack\Samples\SampleApp\CC2530DB\..\. #
#                          .\..\..\..\COMPONENTS\SERVICES\SADDR\" -I          #
#                          "C:\Texas Instruments\ZStack-CC2530-2.3.1\Projects #
#                          \zstack\Samples\SampleApp\CC2530DB\..\..\..\..\..\ #
#                          COMPONENTS\SERVICES\SDATA\" -I "C:\Texas           #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \MAC\INCLUDE\" -I "C:\Texas                        #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \MAC\HIGH_LEVEL\" -I "C:\Texas                     #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \MAC\LOW_LEVEL\srf04\" -I "C:\Texas                #
#                          Instruments\ZStack-CC2530-2.3.1\Projects\zstack\Sa #
#                          mples\SampleApp\CC2530DB\..\..\..\..\..\COMPONENTS #
#                          \MAC\LOW_LEVEL\srf04\SINGLE_CHIP\" -I "C:\Program  #
#                          Files\IAR Systems\Embedded Workbench               #
#                          5.3\8051\INC\" -I "C:\Program Files\IAR            #
#                          Systems\Embedded Workbench 5.3\8051\INC\CLIB\"     #
#                          -Ohz                                               #
#    List file          =  C:\Texas Instruments\ZStack-CC2530-2.3.1\Projects\ #
#                          zstack\Samples\SampleApp\CC2530DB\DemoEB\List\MT_T #
#                          ASK.lst                                            #
#    Object file        =  C:\Texas Instruments\ZStack-CC2530-2.3.1\Projects\ #
#                          zstack\Samples\SampleApp\CC2530DB\DemoEB\Obj\MT_TA #
#                          SK.r51                                             #
#                                                                             #
#                                                                             #
###############################################################################

C:\Texas Instruments\ZStack-CC2530-2.3.1\Components\mt\MT_TASK.c
      1          /***************************************************************************************************
      2            Filename:       MT_TASK.c
      3            Revised:        $Date: 2010-04-20 16:45:06 -0700 (Tue, 20 Apr 2010) $
      4            Revision:       $Revision: 22262 $
      5          
      6            Description:    MonitorTest Task handling routines
      7          
      8            Copyright 2007-2010 Texas Instruments Incorporated. All rights reserved.
      9          
     10            IMPORTANT: Your use of this Software is limited to those specific rights
     11            granted under the terms of a software license agreement between the user
     12            who downloaded the software, his/her employer (which must be your employer)
     13            and Texas Instruments Incorporated (the "License").  You may not use this
     14            Software unless you agree to abide by the terms of the License. The License
     15            limits your use, and you acknowledge, that the Software may not be modified,
     16            copied or distributed unless embedded on a Texas Instruments microcontroller
     17            or used solely and exclusively in conjunction with a Texas Instruments radio
     18            frequency transceiver, which is integrated into your product.  Other than for
     19            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     20            works of, modify, distribute, perform, display or sell this Software and/or
     21            its documentation for any purpose.
     22          
     23            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     24            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     25            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     26            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     27            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     28            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     29            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     30            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     31            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     32            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     33            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     34          
     35            Should you have any questions regarding your right to use this Software,
     36            contact Texas Instruments Incorporated at www.TI.com.
     37          
     38           ***************************************************************************************************/
     39          
     40          /***************************************************************************************************
     41           * INCLUDES
     42           ***************************************************************************************************/
     43          #include "ZComDef.h"
     44          #include "MT_TASK.h"
     45          #include "MT.h"
     46          #include "MT_DEBUG.h"
     47          #include "MT_UART.h"
     48          #include "MT_UTIL.h"
     49          #include "MT_SYS.h"
     50          #include "MT_ZDO.h"
     51          
     52          #if !defined( NONWK )
     53          #include "MT_AF.h"
     54          #endif  /* NONWK */
     55          
     56          #include "hal_uart.h"
     57          #include "OSAL_Memory.h"
     58          
     59          /***************************************************************************************************
     60           * LOCAL FUNCTIONS
     61           ***************************************************************************************************/
     62          void MT_ProcessIncomingCommand( mtOSALSerialData_t *msg );
     63          
     64          /***************************************************************************************************
     65           * GLOBALS
     66           ***************************************************************************************************/
     67          
     68          /***************************************************************************************************
     69           * @fn      MT_TaskInit
     70           *
     71           * @brief  MonitorTest Task Initialization.  This function is put into the
     72           *         task table.
     73           *
     74           * @param   byte task_id - task ID of the MT Task
     75           *
     76           * @return  void
     77           ***************************************************************************************************/
     78          void MT_TaskInit(uint8 task_id)
     79          {
     80            /* Initialize the Serial port */
     81            MT_UartInit();
     82          
     83            /* Register taskID - Do this after UartInit() because it will reset the taskID */
     84            MT_UartRegisterTaskID(task_id);
     85          
     86            /* Initialize MT */
     87            MT_Init(task_id);
     88          }
     89          
     90          /***************************************************************************************************
     91           * @fn      MT_ProcessEvent
     92           *
     93           * @brief MonitorTest Task Event Processor.  This task is put into the task table.
     94           *
     95           * @param   byte task_id - task ID of the MT Task
     96           * @param   UINT16 events - event(s) for the MT Task
     97           *
     98           * @return  void
     99           ***************************************************************************************************/
    100          UINT16 MT_ProcessEvent(uint8 task_id, uint16 events)
    101          {
    102            uint8 *msg_ptr;
    103          
    104            (void)task_id;  // Intentionally unreferenced parameter
    105          
    106            /* Could be multiple events, so switch won't work */
    107            if ( events & SYS_EVENT_MSG )
    108            {
    109              while ( (msg_ptr = osal_msg_receive( MT_TaskID )) )
    110              {
    111                MT_ProcessIncomingCommand((mtOSALSerialData_t *)msg_ptr);
    112              }
    113          
    114              /* Return unproccessed events */
    115              return (events ^ SYS_EVENT_MSG);
    116            }
    117          
    118            if ( events & MT_ZTOOL_SERIAL_RCV_BUFFER_FULL )
    119            {
    120              /* Return unproccessed events */
    121              return (events ^ MT_ZTOOL_SERIAL_RCV_BUFFER_FULL);
    122            }
    123          
    124          #if !defined( NONWK )
    125            if ( events & MT_AF_EXEC_EVT )
    126            {
    127              MT_AfExec();
    128              return (events ^ MT_AF_EXEC_EVT);
    129            }
    130          #endif  /* NONWK */
    131          
    132            /* Handle MT_SYS_OSAL_START_TIMER callbacks */
    133          #if defined MT_SYS_FUNC
    134            if ( events & (MT_SYS_OSAL_EVENT_MASK))
    135            {
    136              if (events & MT_SYS_OSAL_EVENT_0)
    137              {
    138                MT_SysOsalTimerExpired(0x00);
    139                events ^= MT_SYS_OSAL_EVENT_0;
    140              }
    141          
    142              if (events & MT_SYS_OSAL_EVENT_1)
    143              {
    144                MT_SysOsalTimerExpired(0x01);
    145                events ^= MT_SYS_OSAL_EVENT_1;
    146              }
    147          
    148              if (events & MT_SYS_OSAL_EVENT_2)
    149              {
    150                MT_SysOsalTimerExpired(0x02);
    151                events ^= MT_SYS_OSAL_EVENT_2;
    152              }
    153          
    154              if (events & MT_SYS_OSAL_EVENT_3)
    155              {
    156                MT_SysOsalTimerExpired(0x03);
    157                events ^= MT_SYS_OSAL_EVENT_3;
    158              }
    159          
    160              return events;
    161            }
    162          #endif
    163          
    164            /* Discard or make more handlers */
    165            return 0;
    166          
    167          } /* MT_ProcessEvent() */
    168          
    169          /***************************************************************************************************
    170           * @fn      MT_ProcessIncomingCommand
    171           *
    172           * @brief
    173           *
    174           *   Process Event Messages.
    175           *
    176           * @param   byte *msg - pointer to event message
    177           *
    178           * @return
    179           ***************************************************************************************************/
    180          void MT_ProcessIncomingCommand( mtOSALSerialData_t *msg )
    181          {
    182            byte deallocate;
    183            byte *msg_ptr;
    184            byte len;
    185          
    186            /* A little setup for AF, CB_FUNC and MT_SYS_APP_RSP_MSG */
    187            msg_ptr = msg->msg;
    188          
    189            deallocate = true;
    190          
    191            /* Use the first byte of the message as the command ID */
    192            switch ( msg->hdr.event )
    193            {
    194              case CMD_SERIAL_MSG:
    195                MT_ProcessIncoming(msg->msg);
    196                break;
    197          
    198              case CMD_DEBUG_MSG:
    199                MT_ProcessDebugMsg( (mtDebugMsg_t *)msg );
    200                break;
    201          
    202              case CB_FUNC:
    203                /*
    204                  Build SPI message here instead of redundantly calling MT_BuildSPIMsg
    205                  because we have copied data already in the allocated message
    206                */
    207          
    208                /* msg_ptr is the beginning of the intended SPI message */
    209                len = SPI_0DATA_MSG_LEN + msg_ptr[DATALEN_FIELD];
    210          
    211                /*
    212                  FCS goes to the last byte in the message and is calculated over all
    213                  the bytes except FCS and SOP
    214                */
    215                msg_ptr[len-1] = MT_UartCalcFCS(msg_ptr + 1, (byte)(len-2));
    216          
    217          #ifdef MT_UART_DEFAULT_PORT
    218                HalUARTWrite ( MT_UART_DEFAULT_PORT, msg_ptr, len );
    219          #endif
    220                break;
    221          
    222              case CMD_DEBUG_STR:
    223                MT_ProcessDebugStr( (mtDebugStr_t *)msg );
    224                break;
    225          
    226          #if !defined ( NONWK )
    227              case MT_SYS_APP_RSP_MSG:
    228                len = SPI_0DATA_MSG_LEN + msg_ptr[DATALEN_FIELD];
    229                MTProcessAppRspMsg( msg_ptr, len );
    230                break;
    231          #endif  // NONWK
    232          
    233          #if defined (MT_UTIL_FUNC)
    234          #if defined ZCL_KEY_ESTABLISH
    235              case ZCL_KEY_ESTABLISH_IND:
    236                MT_UtilKeyEstablishInd((keyEstablishmentInd_t *)msg);
    237                break;
    238          #endif
    239          #endif
    240          #ifdef MT_ZDO_CB_FUNC
    241              case ZDO_STATE_CHANGE:
    242                MT_ZdoStateChangeCB((osal_event_hdr_t *)msg);
    243                break;
    244          #endif
    245          
    246              default:
    247                break;
    248            }
    249          
    250            if ( deallocate )
    251            {
    252              osal_msg_deallocate( (uint8 *)msg );
    253            }
    254          }
    255          
    256          #ifdef MT_TASK
    257          /***************************************************************************************************
    258           * @fn      MT_TransportAlloc
    259           *
    260           * @brief   Allocate memory for transport msg
    261           *
    262           * @param   uint8 cmd0 - The first byte of the MT command id containing the command type and subsystem.
    263           *          uint8 len - length
    264           *
    265           * @return  pointer the allocated memory or NULL if fail to allocate the memory
    266           ***************************************************************************************************/
    267          uint8 *MT_TransportAlloc(uint8 cmd0, uint8 len)
    268          {
    269            uint8 *p;
    270          
    271            (void)cmd0;  // Intentionally unreferenced parameter
    272          
    273            /* Allocate a buffer of data length + SOP+CMD+FCS (5bytes) */
    274            p = osal_msg_allocate(len + SPI_0DATA_MSG_LEN);
    275          
    276            if (p)
    277            {
    278              p++; /* Save space for SOP_VALUE, msg structure */
    279              return p;
    280            }
    281            else
    282            {
    283              return NULL;
    284            }
    285          }
    286          
    287          /***************************************************************************************************
    288           * @fn      MT_TransportSend
    289           *
    290           * @brief   Fill in SOP and FCS then send out the msg
    291           *
    292           * @param   uint8 *pBuf - pointer to the message that contains CMD, length, data and FCS
    293           *
    294           * @return  None
    295           ***************************************************************************************************/
    296          void MT_TransportSend(uint8 *pBuf)
    297          {
    298            uint8 *msgPtr;
    299            uint8 dataLen = pBuf[0]; /* Data length is on byte #1 from the pointer */
    300          
    301            /* Move back to the SOP */
    302            msgPtr = pBuf-1;
    303          
    304            /* Insert SOP */
    305            msgPtr[0] = MT_UART_SOF;
    306          
    307            /* Insert FCS */
    308            msgPtr[SPI_0DATA_MSG_LEN - 1 + dataLen] = MT_UartCalcFCS (pBuf, (3 + dataLen));
    309          
    310            /* Send to UART */
    311          #ifdef MT_UART_DEFAULT_PORT
    312            HalUARTWrite(MT_UART_DEFAULT_PORT, msgPtr, dataLen + SPI_0DATA_MSG_LEN);
    313          #endif
    314          
    315            /* Deallocate */
    316            osal_msg_deallocate(msgPtr);
    317          }
    318          #endif /* MT_TASK */
    319          /***************************************************************************************************
    320           ***************************************************************************************************/

Errors: 1
Warnings: none
